name: ðŸš€ Rollback Projesi CI/CD

on:
  push:
    branches: [ master, main ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository_owner }}/rollbackproject-api
  
jobs:
  build-test-push:
    runs-on: ubuntu-latest
    
    steps:
    - name: Kodu Ã‡ek
      uses: actions/checkout@v4

    # --- 1. Test OrtamÄ±nÄ± BaÅŸlatma ---
    - name: Docker Compose ile Servisleri BaÅŸlat
      run: docker compose -f docker-compose.yml up -d

    - name: Servislerin BaÅŸlamasÄ±nÄ± Bekle
      run: sleep 45

    # --- 2. k6 TESTLERÄ° ---
    - name: k6 Kurulumu
      uses: grafana/setup-k6-action@v1
      with:
        version: v0.51.0

    - name: k6 YÃ¼k Testini Ã‡alÄ±ÅŸtÄ±r
      uses: grafana/run-k6-action@v1
      with:
        path: test/load-test.js

    # --- 3. Docker Push ---
    - name: GitHub Container Registry'ye GiriÅŸ
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Docker Ä°majÄ±nÄ± Build Et ve GHCR'ye Pushla
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
          ${{ env.DOCKER_IMAGE }}:latest

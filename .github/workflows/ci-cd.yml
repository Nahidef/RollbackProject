name: ğŸš€ Rollback Projesi CI/CD

on:
  push:
    branches: [ master, main ] # master veya main'e push edildiÄŸinde Ã§alÄ±ÅŸ
  workflow_dispatch: # GitHub arayÃ¼zÃ¼nden manuel Ã§alÄ±ÅŸtÄ±rma izni verir

env:
  DOCKER_IMAGE: ghcr.io/${{ github.repository_owner }}/rollbackproject-api # GHCR hedef adresi
  
jobs:
  build-test-push:
    runs-on: ubuntu-latest # Bulut sunucusunda Ã§alÄ±ÅŸacak
    
    steps:
    - name: Kodu Ã‡ek
      uses: actions/checkout@v4

    # --- 1. Test OrtamÄ±nÄ± BaÅŸlatma (Master/Replica DB) ---
    - name: Docker Compose ile Servisleri BaÅŸlat
      # Docker Compose'u bulutta Ã§alÄ±ÅŸtÄ±rÄ±r ve API'nin veritabanlarÄ±na baÄŸlanmasÄ±nÄ± saÄŸlar
      run: docker compose -f docker-compose.yml up -d

    - name: Servislerin BaÅŸlamasÄ±nÄ± Bekle
      run: sleep 45 # Master ve Replica'nÄ±n senkronize olmasÄ± iÃ§in bekleme sÃ¼resi

    # --- 2. k6 YÃ¼k Testi (Rollback Kriteri) ---
    - name: Go Kurulumu
      uses: actions/setup-go@v5
      with:
        go-version: '1.23' 

    - name: k6 Kurulumu ve Testi BaÅŸlatma
      uses: k6io/action@v0.4.0
      with:
        k6-version: latest
    
    # â­ï¸ KRÄ°TÄ°K: Bu test BAÅARISIZ olursa (Ã¶rneÄŸin hata oranÄ± > %1 olursa), pipeline durur.
    - name: k6 YÃ¼k Testini Ã‡alÄ±ÅŸtÄ±r
      run: k6 run test/load-test.js

    # --- 3. Docker Ä°majÄ±nÄ± Pushlama (YÃ¼kleme) ---
    - name: GitHub Container Registry'ye (GHCR) GiriÅŸ
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }} # GitHub'Ä±n otomatik saÄŸladÄ±ÄŸÄ± gizli token kullanÄ±lÄ±r

    - name: Docker Ä°majÄ±nÄ± Build Et ve GHCR'ye Pushla
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ${{ env.DOCKER_IMAGE }}:${{ github.sha }} # Commit ID'si ile etiketle (Benzersiz Versiyon)
          ${{ env.DOCKER_IMAGE }}:latest # En son versiyon olarak etiketle